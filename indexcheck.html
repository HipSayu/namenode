<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>Upload</title>
</head>
<body>
    <div style="display: flex;flex-direction: column;">
        <h1>Write</h1>
        <form id="form" enctype="multipart/form-data">
            <label for="name">Name File</label>
            <input type="text" name="name" id="" required>
            <label for="description">description</label>
            <input type="text" name="description" id="" required>
            <label for="image">image</label>
            <input type="file" id="image" onchange="handleFileUpload()">
            <button>Submit</button>
        </form>
        <h1>Read</h1>
        <form id="form_Read">
            <label for="name">Name File</label>
            <input type="text" name="name" id="" required>
            <button>download</button>
        </form>
        
        

    </div>
</body>

<script >

    let uploadFile 
    let SizeFileUpload
    let typeFile
    let dataimage = ''
    let nameFileRead

    // function base64toBlob(base64String, mimeType) {
    //     // Split the base64 string to get the data and mime type
    //     const parts = base64String.split(';base64,');
    //     const contentType = parts[0].replace('data:', '') || mimeType;
    //     const raw = window.atob(parts[1]);
    //     const rawLength = raw.length;
    //     const uInt8Array = new Uint8Array(rawLength);

    //     // Convert the binary data to Uint8Array
    //     for (let i = 0; i < rawLength; ++i) {
    //         uInt8Array[i] = raw.charCodeAt(i);
    //     }

    //     // Create a Blob from the Uint8Array
    //     return new Blob([uInt8Array], { type: contentType });
    // }

    function downloadBlob(blob, fileName) {
        // Create a temporary link element
        const link = document.createElement('a');

        // Set the download attribute and create a data URL for the Blob
        link.download = fileName;
        link.href = URL.createObjectURL(blob);

        // Append the link to the document, trigger a click, and remove the link
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Revoke the Object URL to free up resources
        URL.revokeObjectURL(link.href);
    }

    //Split file
  function SplitFile(file, numberChunk) {
        const Files = [];
        const sizeFile = file.length
        const chunkSize = []
        
        if (sizeFile%numberChunk !==0 ){
            var mod = sizeFile - sizeFile%numberChunk
            for (let i =0; i < numberChunk ; i++){
                chunkSize.push(i*mod/numberChunk)

            }
            chunkSize.push(numberChunk*mod/numberChunk + sizeFile%numberChunk)
            // console.log(chunkSize)
            for (let i = 1; i < chunkSize.length; i += 1) {
                Files.push(file.slice(chunkSize[i-1], chunkSize[i-1] + chunkSize[i]));
            }
        }
        else{
            for (let i = 0; i < sizeFile; i += sizeFile/numberChunk) {
                Files.push(file.slice(i, i + sizeFile/numberChunk));
            }
        }
            // console.log(Files)
        return Files;
  }
  //Upload
    function handleFileUpload() {
        const fileInput = document.getElementById('image');
        if (fileInput.files.length > 0) {
            const uploadedFile = fileInput.files[0];
            SizeFileUpload = uploadedFile.size
            const fileReader = new FileReader();
            fileReader.onload = function(event) {
                uploadFile = event.target.result;
            };
            fileReader.readAsDataURL(uploadedFile);
        } else {
            console.error('No file selected.');
        }
    }
    
    //SENN namenode
    let form = document.getElementById('form')
    form.addEventListener('submit', async (e)=>{
        e.preventDefault()
        let formData = new FormData(form)   
        formData.append("Request", "Write")
        formData.append("sizeFile", SizeFileUpload)

        let data =Object.fromEntries(formData)

        await axios.post('http://localhost:1611/clientRequest',data)
            .then((res)=> {
                // console.log(res)
                // console.log('data', res.data)
                let numberChunk = res.data.NumberChunk
                let metaDatas = res.data.metaDatas
                // console.log(metaDatas)
                let Files = SplitFile(uploadFile, numberChunk)
                // console.log('dataNode', metaDatas[0].DataNode )
                // let test = {...metaDatas[0],request : 'write' }
                // console.log('test', test)
               
                Promise.all([
                    axios.post(metaDatas[0].DataNode, {...metaDatas[0],request : 'write' ,File: Files[0]}),
                    axios.post(metaDatas[1].DataNode, {...metaDatas[1],request : 'write' ,File: Files[1]}),
                    axios.post(metaDatas[2].DataNode, {...metaDatas[2],request : 'write' ,File: Files[2]})
                ])
                .then(res=>{console.log(res)  })
                .catch((err) => console.log(err))

            })  
    })



    //Read DataNode
    let imageElement = document.getElementById('imageElement')
    let form_Read = document.getElementById('form_Read')
    form_Read.addEventListener('submit', async (e)=>{
        e.preventDefault()
        let formDataRead = new FormData(form_Read)   
        formDataRead.append("Request", "read")
        let data =Object.fromEntries(formDataRead)
        await axios.post('http://localhost:1611/clientRequest', data)
            .then((res) =>{
                if(res.data == 'Not in DB'){
                    console.log('No co file')
                }
                else{
                    console.log(res)
                    var metadata = res.data.metadata
                    let dataRead = {
                        nameFile :metadata[0].nameFile,
                        request:'read'
                    }
                    Promise.all([
                            axios.post(metadata[0].DataNode, {...dataRead, indexFile : metadata[0].indexFile}),
                            axios.post(metadata[1].DataNode,  {...dataRead, indexFile : metadata[1].indexFile}),
                            axios.post(metadata[2].DataNode,  {...dataRead, indexFile : metadata[2].indexFile})
                        ])
                        .then(async res=>{
                            console.log(res)
                            var datas='' 
                            nameFileRead = res[0].data.nameFile,
                            res.forEach((element, index)=>{
                                var data = element.data.File
                                datas = datas + data
                            })

                            // console.log(datas)
                            var parts = datas.split(';');
                            var typedata = parts[0].split(':');
                            typeFile =typedata[1]
                            console.log('check type ',typeFile)
                            var rar = typeFile.split('/')
                            var nameFiledonwlaod = nameFileRead +'.'+ rar[1]

                            const base64Response = await fetch(datas)
                            const blob = await base64Response.blob();
                            console.log(blob)
                            dataimage = datas
                            
                            downloadBlob(blob, nameFiledonwlaod);
                           
                          })
                        .catch((err) => console.log(err))
                }
        })
    })


    //Donwload
//     async function downloadImage(imageSrc, nameOfDownload = 'my-image.png',) {
//             const response = await fetch(imageSrc);

//             const blobImage = await response.blob();

//             const href = URL.createObjectURL(blobImage);

//             const anchorElement = document.createElement('a');
//             anchorElement.href = href;
//             anchorElement.download = nameOfDownload;

//             document.body.appendChild(anchorElement);
//             anchorElement.click();

//             document.body.removeChild(anchorElement);
//             window.URL.revokeObjectURL(href);
// }

// const btn = document.getElementById('btn');

// btn.addEventListener('click', () => {
//   downloadImage(dataimage,'my-image.png',)
//     .then(() => {
//       console.log('The image has been downloaded');
//     })
//     .catch(err => {
//       console.log('Error downloading image: ', err);
//     });
// });
        
</script>
</html>